# 标注系统v2.0问题修复报告

## 问题总结
用户反馈了三个关键问题：
1. 盘面上显示不出来标注内容（无论是圈还是字都没能显示）
2. 中宫的内容不能选中（无法右键操作）
3. 盘面参数右键菜单文字hover时变白，看不见字

## 问题分析与解决方案

### 问题1：标注内容显示异常

**根本原因**：
- 标注文字绘制位置计算错误，y坐标为负值导致文字绘制在控件可视区域之外
- 圆圈半径过大，在小尺寸控件中显示不全

**解决方案**：
```python
# 修复前：文字位置计算错误
text_rect = QRect(
    center_x - self.width()//2, 
    center_y - radius - 20,  # 可能为负值
    self.width(), 
    15
)

# 修复后：文字显示在控件顶部
text_rect = QRect(
    0, 
    0, 
    self.width(), 
    12
)
```

**修复文件**：`ui/widgets/parameter_widget.py` - `_draw_annotations`方法

### 问题2：中宫格子无法选中

**根本原因**：
- 中宫只设置了位置5（局数）和位置9（地盘干）的ParameterWidget
- 其他位置（1,2,3,4,6,7,8）没有设置参数ID，无法响应右键菜单

**解决方案**：
```python
# 为中宫所有格子设置参数ID
for i in range(1, 10):
    if i == 5:
        # 设置局数信息
        param_id = f"palace_{palace_data.index}_ju_shu"
        self.param_widgets[5].set_data(ju_shu_text, config, tu_color, False, param_id)
    elif i == 9:
        # 设置地盘干信息
        param_id = f"palace_{palace_data.index}_earth_stem_0"
        self.param_widgets[9].set_data(earth_stem, config, color, False, param_id)
    else:
        # 其他格子设置为可操作的空格子
        param_id = f"palace_{palace_data.index}_position_{i}"
        self.param_widgets[i].set_data("", config, "#000000", False, param_id)
```

**修复文件**：`ui/widgets/palace_widget.py` - `_update_center_palace`方法

### 问题3：右键菜单文字变白

**根本原因**：
- 应用程序的全局样式表影响了QMenu的hover状态
- 菜单项在hover时缺乏明确的文字颜色定义

**解决方案**：
为右键菜单添加专门的样式表：
```python
menu.setStyleSheet("""
    QMenu {
        background-color: #f0f0f0;
        border: 1px solid #999;
        border-radius: 3px;
        padding: 2px;
    }
    QMenu::item {
        background-color: transparent;
        color: #000000;
        padding: 5px 20px;
        margin: 1px;
        border-radius: 2px;
    }
    QMenu::item:selected {
        background-color: #4285f4;
        color: #ffffff;
    }
    QMenu::item:disabled {
        color: #666666;
        background-color: transparent;
    }
""")
```

**修复文件**：`ui/widgets/parameter_widget.py` - `_show_context_menu`方法

## 额外改进

### 标注数据刷新机制优化
修复了标注面板的数据变更信号发射，确保图表能及时刷新标注显示：

```python
def _emit_change(self):
    """发射数据变更信号"""
    if hasattr(self, 'current_case') and self.current_case:
        # 触发图表刷新
        self.annotation_edited.emit("", {})
```

**修复文件**：`ui/widgets/annotation_panel_widget.py`

## 测试验证

### 功能测试
- ✅ 标注圆圈正确显示在控件中央
- ✅ 标注文字正确显示在控件顶部
- ✅ 中宫所有格子支持右键操作
- ✅ 右键菜单文字hover时清晰可见
- ✅ 标注数据变更后图表及时刷新

### 视觉效果
- ✅ 标注圆圈：半透明黄色背景，红色边框
- ✅ 标注文字：红色粗体，顶部居中显示
- ✅ 右键菜单：标准系统风格，hover有蓝色高亮

## 用户体验改进

1. **标注可见性**：标注内容现在清晰可见，不会被遮挡
2. **操作完整性**：中宫的所有格子都支持标注操作
3. **界面友好性**：右键菜单文字在任何状态下都清晰可读
4. **响应及时性**：标注变更立即反映在图表显示上

## 后续建议

1. **性能优化**：考虑缓存绘制结果，减少重复绘制
2. **样式定制**：允许用户自定义标注圆圈和文字的颜色
3. **位置优化**：根据控件大小动态调整标注元素位置
4. **交互增强**：考虑添加标注的hover提示功能

---
*修复完成时间: 2025年9月7日*
*涉及文件: 3个核心widget文件*
*修复状态: 已验证通过*
