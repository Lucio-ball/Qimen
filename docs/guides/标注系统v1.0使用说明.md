# 奇门遁甲工作台 - 标注系统v1.0 使用说明

## 概述

标注系统v1.0为奇门遁甲工作台提供了完整的参数标注功能，用户可以为盘面中的任意参数（八神、九星、八门、天干地支等）添加自定义标注，支持不同颜色和形状的标注标记。

## 功能特性

### 1. 数据模型升级
- **Case类**: 新增案例数据模型，包装ChartResult和用户标注
- **标注存储**: 每个案例独立管理标注数据
- **参数ID系统**: 为每个可标注参数分配唯一标识符

### 2. 可视化组件

#### AnnotationPanelWidget (标注管理面板)
- **位置**: 右侧停靠面板，与属性面板并列显示
- **功能**: 
  - 显示当前案例的所有标注列表
  - 支持标注的添加、编辑、删除操作
  - 提供标注文本、形状、颜色的自定义设置
  - 实时统计标注数量

#### ParameterWidget (参数显示组件)
- **升级功能**: 
  - 支持右键菜单进行标注操作
  - 在参数右上角显示标注标记
  - 支持圆形、方形、三角形标注形状
  - 自定义标注颜色显示

### 3. 交互功能

#### 右键菜单操作
- **未标注参数**: 显示"添加标注"选项
- **已标注参数**: 显示"编辑标注"和"删除标注"选项
- **参数信息**: 显示当前参数的名称和位置

#### 标注面板操作
- **列表显示**: 以易读格式显示所有标注（如"一宫-八神: 用神"）
- **编辑区域**: 提供文本输入、形状选择、颜色选择控件
- **批量操作**: 支持清空所有标注功能

## 参数ID命名规则

### 基本格式
```
palace_{宫位索引}_{参数类型}[_{索引}]
```

### 具体示例
- `palace_1_god` - 一宫八神
- `palace_1_star_0` - 一宫九星（第一个）
- `palace_1_gate` - 一宫八门
- `palace_1_heaven_stem_0` - 一宫天盘干（主要）
- `palace_1_heaven_stem_1` - 一宫天盘干（寄宫1）
- `palace_1_earth_stem_0` - 一宫地盘干（主要）
- `palace_5_ju_shu` - 中宫局数信息

## 标注数据结构

### 标注对象格式
```python
{
    "text": "用神",           # 标注文本
    "shape": "circle",       # 形状: circle/square/triangle
    "color": "#FF0000"       # 颜色: 十六进制颜色值
}
```

### 案例存储结构
```python
case.annotations = {
    "palace_1_god": {"text": "用神", "shape": "circle", "color": "#FF0000"},
    "palace_2_star_0": {"text": "值符", "shape": "square", "color": "#00FF00"},
    # ... 更多标注
}
```

## 使用流程

### 1. 基本标注操作

1. **添加标注**:
   - 右键点击任意参数
   - 选择"添加标注"
   - 在标注面板中编辑标注内容
   - 点击"更新标注"保存

2. **编辑标注**:
   - 右键点击已标注参数选择"编辑标注"
   - 或在标注面板中点击标注项
   - 修改文本、形状、颜色
   - 点击"更新标注"保存更改

3. **删除标注**:
   - 右键点击已标注参数选择"删除标注"
   - 或在标注面板中选择标注项后点击"删除标注"

### 2. 标注面板管理

1. **查看标注列表**:
   - 所有标注按参数位置自动分组显示
   - 图标显示标注的颜色和形状
   - 文本显示参数位置和标注内容

2. **批量操作**:
   - 使用"清空全部"功能删除所有标注
   - 通过标注统计了解标注数量

### 3. 案例切换

- 切换标签页时，标注面板自动显示当前案例的标注
- 每个案例的标注数据独立存储
- 标注信息随案例一起保存和恢复

## 技术实现

### 1. 信号连接机制
```python
# ParameterWidget发射标注请求信号
parameter_widget.annotation_requested.connect(main_window.handle_annotation_request)
parameter_widget.annotation_edit_requested.connect(main_window.handle_annotation_edit)
parameter_widget.annotation_remove_requested.connect(main_window.handle_annotation_remove)

# AnnotationPanel发射标注变更信号
annotation_panel.annotation_edited.connect(main_window.handle_annotation_edited)
annotation_panel.annotation_deleted.connect(main_window.handle_annotation_deleted)
```

### 2. 标注数据同步
- 主窗口作为数据协调中心
- 标注变更时自动刷新相关组件显示
- 确保数据一致性和界面同步

### 3. 组件扩展性
- PalaceWidget新增`get_parameter_widgets()`和`refresh_annotations()`方法
- ChartWidget新增标注刷新机制
- 支持未来扩展更多标注功能

## 测试验证

### 运行测试程序
```bash
python test_annotation_system.py
```

### 测试功能
- ✅ Case数据模型创建和管理
- ✅ AnnotationPanelWidget界面显示
- ✅ ParameterWidget右键菜单
- ✅ 标注添加、编辑、删除操作
- ✅ 标注数据持久化
- ✅ 界面组件信号连接

## 已知限制

1. **标注持久化**: 当前标注数据仅在会话期间保存，未实现文件保存功能
2. **标注导出**: 暂未支持标注数据的导出和分享功能
3. **标注样式**: 标注形状和颜色选项有限，可根据需要扩展

## 未来扩展方向

1. **标注模板**: 预定义常用标注模板（如"用神"、"忌神"等）
2. **标注分类**: 支持标注分类管理和筛选显示
3. **标注导出**: 支持将标注信息导出为图片或报告
4. **标注协作**: 支持标注的分享和协作编辑功能
5. **智能标注**: 基于AI的自动标注建议功能

---

**标注系统v1.0开发完成！** 🎉

现在用户可以在奇门遁甲工作台中自由地为任意参数添加个人标注，极大提升了分析和学习的效率。
