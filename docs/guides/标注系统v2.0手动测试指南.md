# 标注系统v2.0手动集成测试指南

## 测试环境准备
1. 确保应用程序正常运行 `python main_integrated.py`
2. 确保模板文件 `data/templates.json` 存在且内容正确

## 测试场景1：模板应用功能

### 步骤：
1. 启动应用程序
2. 点击"新建案例"创建一个新案例
3. 输入任意时间（例如：2024年12月1日 14:30）
4. 完成案例创建，等待排盘结果显示
5. 观察右侧停靠面板，确认"标注管理 v2.0"面板可见
6. 切换到"模板应用"选项卡
7. 在下拉框中选择"婚姻恋爱"模板
8. 观察模板预览区域显示模板内容
9. 点击"应用模板到当前图层"按钮

### 期望结果：
- 系统应显示成功消息"成功应用模板 '婚姻恋爱'，添加了 X 个标注"
- 盘面上应自动出现相关标注（如六合、乙奇、庚金等相关参数的标注）
- 切换到"标注管理"选项卡，应能看到新添加的标注列表
- 状态栏应显示"已应用模板: 婚姻恋爱"

## 测试场景2：图层隔离功能

### 步骤：
1. 在上一个测试的基础上，切换到"图层管理"选项卡
2. 点击"新建图层"按钮
3. 输入图层名称："测事业"，确认
4. 观察图层列表，确认新图层已创建并被激活
5. 切换到"模板应用"选项卡
6. 选择"工作晋升"模板并应用
7. 切换回"标注管理"选项卡，观察标注列表
8. 切换到"图层管理"选项卡
9. 取消勾选"测事业"图层的可见性
10. 勾选"默认图层"的可见性

### 期望结果：
- 新图层应成功创建并显示在图层列表中
- 当前图层标签应更新为"当前图层: 测事业"
- 应用"工作晋升"模板后，应看到开门、值符等相关标注
- 标注列表应只显示当前激活图层（测事业）的标注
- 切换图层可见性时，盘面上的标注应立即切换
- 隐藏"测事业"图层后，应显示"婚姻恋爱"相关的标注
- 显示"测事业"图层后，应显示"工作晋升"相关的标注

## 测试场景3：图层可见性组合

### 步骤：
1. 在图层管理中，同时勾选"默认图层"和"测事业"图层的可见性
2. 切换到"标注管理"选项卡，观察标注列表
3. 在盘面上观察标注显示

### 期望结果：
- 标注列表应显示当前激活图层的标注
- 盘面上应同时显示两个图层的所有标注
- 如果同一个参数在两个图层都有标注，应显示合并的标注

## 测试场景4：图层管理操作

### 步骤：
1. 在图层列表中选择"默认图层"
2. 点击"重命名"按钮，将其重命名为"婚姻图层"
3. 尝试删除"婚姻图层"（应该失败，因为至少需要一个图层）
4. 选择"测事业"图层，点击"删除图层"
5. 确认删除操作

### 期望结果：
- 重命名操作应成功，图层名称应更新为"婚姻图层"
- 当只有一个图层时，删除按钮应被禁用或操作应失败并显示警告
- 删除"测事业"图层应成功，该图层及其所有标注应被移除
- 删除后应自动激活剩余的图层

## 测试场景5：向后兼容性

### 步骤：
1. 在盘面上右键点击任意参数（如天盘干、九星等）
2. 选择"添加标注"选项
3. 在弹出的对话框中添加手动标注
4. 观察标注是否正确添加到当前激活图层

### 期望结果：
- 右键菜单功能应正常工作
- 手动添加的标注应出现在当前激活图层中
- 标注应正确显示在盘面和标注列表中

## 测试场景6：数据持久性

### 步骤：
1. 创建多个图层，每个图层应用不同模板
2. 在不同图层中添加手动标注
3. 切换不同图层的可见性
4. 观察数据是否保持一致

### 期望结果：
- 每个图层的标注数据应独立保存
- 切换图层时不应丢失任何标注数据
- 图层可见性状态应正确保存和恢复

## 通过标准

所有测试场景都应该按预期工作，具体要求：

1. **模板功能正常**：能够选择模板并成功应用，生成相应的标注
2. **图层隔离有效**：不同图层的标注相互独立，可以单独管理
3. **可见性控制**：能够控制图层的显示/隐藏，盘面正确反映当前可见的标注
4. **图层管理完整**：支持创建、重命名、删除图层（保留至少一个图层的限制）
5. **向后兼容性**：原有的手动标注功能仍然正常工作
6. **数据一致性**：所有操作后数据状态正确，无数据丢失或错误

## 问题排查

如果遇到问题，请检查：

1. **模板文件**：确认 `data/templates.json` 文件存在且格式正确
2. **控制台输出**：查看是否有错误信息输出
3. **图层状态**：确认当前激活图层和可见性设置
4. **信号连接**：确认模板和图层相关的信号正确连接到主窗口
