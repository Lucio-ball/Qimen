# 奇门遁甲工作台 - 案例持久化系统使用说明

## 项目信息
- **项目代号**: QMW-Persistence (Qi Men Workbench - Persistence Layer)
- **任务ID**: FEAT-20250901-019
- **实现日期**: 2025年9月9日

## 功能概述

本次升级为奇门遁甲工作台添加了完整的案例持久化系统，允许用户保存、管理和复盘分析工作。

## 主要功能

### 1. 案例保存
- **保存当前案例** (`Ctrl+S`): 保存当前正在分析的案例，包括盘面数据和所有标注
- **另存为** (`Ctrl+Shift+S`): 将当前案例保存为新的副本
- 自动保存案例的创建时间、起局时间和所有标注图层

### 2. 案例浏览器
- **左侧停靠面板**: 显示所有已保存的案例列表
- **案例信息**: 显示案例名称、起局时间和保存时间
- **双击打开**: 双击案例项在新标签页中打开案例
- **右键菜单**: 提供打开和删除操作
- **刷新功能**: 手动刷新案例列表

### 3. 案例管理
- **删除案例**: 可以删除不需要的案例（操作不可撤销）
- **多标签页**: 同时打开多个案例进行对比分析
- **实时同步**: 案例列表与标签页状态实时同步

### 4. 数据持久化
- **SQLite数据库**: 使用轻量级SQLite数据库存储案例
- **JSON序列化**: 盘面数据和标注信息完整序列化保存
- **数据完整性**: 保存时自动验证数据完整性

## 用户界面

### 文件菜单新增项目
```
文件(F)
├── 新建案例(N)         Ctrl+N
├── ──────────────
├── 保存当前案例(S)     Ctrl+S       [新增]
├── 另存为(A)...       Ctrl+Shift+S  [新增]
├── ──────────────
├── 关闭当前案例(C)     Ctrl+W
├── ──────────────
└── 退出(X)            Ctrl+Q
```

### 视图菜单新增项目
```
视图(V)
├── 案例浏览器         [新增]
├── 属性面板
└── 标注面板
```

### 停靠面板布局
```
┌─────────────┬─────────────────────┬─────────────┐
│             │                     │   属性面板   │
│  案例浏览器  │     主工作区域       ├─────────────┤
│   [新增]    │   (多标签页案例)     │   标注面板   │
│             │                     │             │
└─────────────┴─────────────────────┴─────────────┘
```

## 使用流程

### 场景1: 创建和保存新案例
1. 点击"文件 -> 新建案例"或使用`Ctrl+N`
2. 在查询对话框中输入起局信息
3. 在盘面上添加标注和分析
4. 点击"文件 -> 保存当前案例"或使用`Ctrl+S`
5. 案例自动保存，并在案例浏览器中显示

### 场景2: 打开已保存的案例
1. 在左侧案例浏览器中找到目标案例
2. 双击案例项或右键选择"打开案例"
3. 案例在新标签页中打开，包含完整的盘面和标注
4. 可以继续编辑和保存修改

### 场景3: 管理案例
1. 在案例浏览器中选择要删除的案例
2. 点击"删除选中"按钮或右键选择"删除案例"
3. 确认删除操作（不可撤销）
4. 如果案例正在标签页中打开，对应标签页会自动关闭

## 技术架构

### 核心组件

#### 1. DataManager (`core/data_manager.py`)
- 数据访问层，封装所有数据库操作
- 提供案例的增删改查功能
- 处理JSON序列化和反序列化

#### 2. CaseBrowserWidget (`ui/widgets/case_browser_widget.py`)
- 案例浏览器UI组件
- 显示案例列表和提供用户交互
- 发射案例操作信号

#### 3. 序列化系统
- `Palace.to_dict()` / `Palace.from_dict()`: 宫位数据序列化
- `ChartResult.to_dict()` / `ChartResult.from_dict()`: 排盘结果序列化
- `Case.id`: 案例数据库ID属性

### 数据库结构
```sql
CREATE TABLE cases (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    creation_time TEXT NOT NULL,
    query_time TEXT NOT NULL,
    chart_result_json TEXT NOT NULL,
    annotation_layers_json TEXT NOT NULL,
    duan_yu_markdown TEXT,        -- 预留
    feedback_text TEXT            -- 预留
);
```

## 文件结构
```
core/
├── data_manager.py          [新增] 数据访问层
└── models.py               [修改] 添加序列化方法和Case.id

ui/widgets/
├── case_browser_widget.py   [新增] 案例浏览器组件
└── ...

ui/windows/
└── integrated_main_window.py [修改] 集成持久化功能

qimen_cases.db              [自动生成] SQLite数据库文件
```

## 测试指南

### 手动功能测试

#### 测试1: 案例创建与保存
1. 启动应用程序
2. 新建案例并添加标注
3. 保存案例（`Ctrl+S`）
4. **预期结果**: 案例浏览器显示新保存的案例，状态栏提示保存成功

#### 测试2: 案例加载
1. 在案例浏览器中双击已保存的案例
2. **预期结果**: 新标签页打开，显示完整的盘面和标注

#### 测试3: 数据持久性
1. 保存案例并关闭程序
2. 重新启动程序
3. **预期结果**: 案例浏览器中显示之前保存的案例

#### 测试4: 案例删除
1. 选择案例并点击删除
2. 确认删除操作
3. **预期结果**: 案例从列表中消失，如果正在打开则标签页关闭

## 性能特性

- **轻量级**: 使用SQLite，无需额外数据库服务器
- **高效**: JSON序列化保证数据完整性
- **安全**: 数据库操作使用事务确保一致性
- **可扩展**: 预留字段支持未来功能扩展

## 注意事项

1. **数据安全**: 删除操作不可撤销，请谨慎操作
2. **文件位置**: 数据库文件`qimen_cases.db`保存在程序根目录
3. **备份建议**: 重要案例建议定期备份数据库文件
4. **并发限制**: 当前版本不支持多实例同时访问数据库

## 故障排除

### 常见问题

#### Q: 保存失败提示"序列化案例数据失败"
A: 检查案例数据完整性，确保排盘结果正常

#### Q: 案例浏览器显示为空
A: 点击刷新按钮，或检查数据库文件是否存在

#### Q: 加载案例失败
A: 案例可能已被删除或数据损坏，尝试刷新列表

#### Q: 程序启动时数据库错误
A: 检查程序目录权限，确保可以创建和读写文件

## 开发完成确认

✅ 所有核心功能已实现并测试通过
✅ 用户界面集成完成
✅ 数据持久化稳定可靠
✅ 文档完整，可投入使用

---
**开发完成日期**: 2025年9月9日
**版本**: v1.0.0
**状态**: 生产就绪
