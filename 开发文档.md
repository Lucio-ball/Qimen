### **奇门遁甲工作台 - 开发文档**

#### **1. 创意来源**

在奇门遁甲的学习、研究与实践过程中，使用者常常面临信息割裂的困境。排盘通常依赖于A软件，案例记录可能在B笔记应用中，而格局、用神的深入分析则需要不断翻阅C书籍或D网站。整个分析流程被切割得支离破碎，极大地影响了效率和思路的连贯性。

此外，盘面信息庞杂，关键用神淹没在众多符号之中，难以聚焦。对于同一个盘面，从不同角度（如测事业、测感情）进行分析时，各类标注混杂在一起，容易造成思路混乱。

因此，需要有一款能够将**排盘、分析、标注、案例管理**无缝整合的专业级桌面软件，来帮助奇门遁甲的深度爱好者和专业研究者，拥有一个高效、连贯、可深度定制的数字化工作环境。

本“奇门遁甲工作台”应运而生，旨在成为奇门遁甲领域的“VSCode”，为使用者提供一个强大、智能、个性化的分析平台。

#### **2. 实现思路**

本项目采用经典的**客户端**架构，不依赖外部服务器（除未来扩展的“案例广场”等功能外），所有计算和数据存储均在本地完成，保证了用户的隐私和软件的离线可用性。

**(1) 核心引擎 (Core Engine)**

*   **排盘算法**: 核心引擎 (`PaiPanEngine`) 采用纯Python实现，严格遵循时家奇门的排盘规则。
*   **历法计算**: 为了保证绝对的精准性，我们没有自行编写复杂的历法算法，而是集成了两个业界公认的、经过严格测试的第三方库：
    *   **节气计算**: 使用 `pyplanets` 库，基于VSOP87天文算法精确计算太阳黄经，从而确定二十四节气。
    *   **四柱计算**: 使用 `ichingpy` 库，它能精确处理以立春为新年界限的干支纪时规则。
*   **数据模型**: 设计了专家级的数据模型（如 `ChartResult`, `Palace`），能够精确区分天地盘星、门、干，并存储天乙、直符等高级概念。
*   **智能分析**: 引擎在完成基础排盘后，会自动进行一轮分析计算，包括六击、入墓、空亡、月令、马星、以及复杂的“马星冲动”逻辑，并将这些结构化的分析数据提供给UI层。
*   **查询索引**: `ChartResult`对象在创建时，会自动构建一个反向查询索引，为上层的“自动化模板”功能提供了高性能的参数查询能力。

**(2) 客户端 (UI)**

*   **GUI框架**: 客户端采用 **PySide6** (Qt for Python) 框架构建，保证了应用的跨平台能力和专业级的UI表现力。
*   **顶层架构**: 采用了**“壳核分离”**的设计。`QMainWindow`作为提供菜单栏和可停靠区域的“外壳”，中央放置一个基于`QStackedLayout`的页面管理器“内核”，完美解决了Dock Widget的停靠问题，并实现了“欢迎页面”与“多案例页面”的平滑切换。
*   **多案例管理**: 中央工作区使用`QTabWidget`（标签页控件），允许用户同时打开、编辑和分析多个案例，实现了真正的非线性工作台体验。
*   **组件化设计**: UI被拆分为一系列高度可复用的独立组件，如`ParameterWidget`（单个参数）、`PalaceWidget`（单个宫位）、`ChartWidget`（完整盘面）、`AttributePanelWidget`（属性面板）等。
*   **自定义渲染**: 盘面的核心显示单元 (`ParameterWidget`) 采用完全的**自定义绘制** (`paintEvent`)，而不是简单的控件堆砌。这为实现“画圈+小字”标注、选中高亮、以及各种复杂的自定义样式提供了无限的可能性。
*   **个性化配置**: 引入了`ConfigManager`和`DisplayConfig`模型，所有显示相关的选项（如五行颜色、标注可见性）均可由用户在“首选项”页面中进行深度定制，并自动持久化保存。

#### **3. 运行环境**

**(1) 运行**
*   本项目通过 **PyInstaller** 打包为独立的Windows `.exe`可执行文件。
*   用户无需安装Python环境或任何依赖库，下载后可直接运行。

**(2) 开发与编译**
*   **Python版本**: Python 3.9+
*   **GUI框架**: PySide6
*   **IDE**: PyCharm Community Edition
*   **核心依赖库**: `pyplanets`, `ichingpy`
*   只保证在上述环境下可以完成编译。

#### **4. 技术细节**

*   **配置持久化**: 使用`QSettings`类，它能优雅地处理跨平台的配置存储（Windows下使用注册表，macOS/Linux下使用配置文件），保证了用户设置的自动保存和恢复。
*   **案例数据存储**: 采用了**SQLite**数据库作为案例的持久化方案。每个`.qmw`（奇门工作台）文件都是一个独立的SQLite数据库。`Case`对象中的复杂数据（如`ChartResult`, `annotation_layers`）被序列化为JSON字符串后存入数据库的TEXT字段，这种设计兼顾了数据库的查询性能和数据结构的灵活性。
*   **架构模式**: 严格遵循**“模型-视图-控制器”**（MVC）的分离思想。`core`模块为模型，`ui`模块中的组件为视图和控制器。同时，在UI内部广泛使用了Qt的**信号与槽（Signals & Slots）机制**，实现了各组件之间的低耦合通信。

#### **5. 收获**

*   (1) 基本掌握了大型桌面软件的**系统架构设计**，从简单的单体应用，逐步演进到基于页面管理、多文档、可停靠面板的复杂“工作台”架构。
*   (2) 全面实践了**组件化**和**数据驱动**的UI开发思想。通过将UI拆分为可复用的积木，并使其显示完全由传入的数据和配置决定，极大地提升了代码的可维护性和可扩展性。
*   (3) 深刻理解了**交互设计**的重要性。通过引入自动化模板、图层管理、自定义标注、以及个性化首选项，软件从一个静态的工具，转变为一个能响应用户意图、适应用户习惯的智能平台。
*   (4) 掌握了**发布工程 (Release Engineering)** 的基本流程，包括使用PyInstaller处理复杂的非代码资源依赖，以及编写`.spec`配置文件，最终将一个复杂的Python项目转化为可供最终用户使用的产品。
*   (5) 在与您的合作中，不断学习和领悟了奇门遁甲的深邃逻辑，并将这些复杂的业务规则，精确地翻译为健壮、可靠的算法和数据结构，这是一次非常宝贵的、跨领域知识融合的经历。